#!/bin/bash
#
# Pre-commit hook para executar verifica√ß√µes de qualidade de c√≥digo
# Executa as mesmas verifica√ß√µes do CI (Black, isort, Flake8, MyPy)
#
# Para instalar:
#   cp hooks/pre-commit.sample .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

echo "üîç Executando verifica√ß√µes de qualidade de c√≥digo..."

# Verifica se est√° rodando dentro do Docker ou localmente
if command -v docker &> /dev/null && docker ps | grep -q lacrei-2025-tl-web-1; then
    DOCKER_CMD="docker exec lacrei-2025-tl-web-1"
    echo "‚úì Usando container Docker"
else
    DOCKER_CMD=""
    echo "‚úì Executando localmente"
fi

# Verifica formata√ß√£o com Black
echo ""
echo "üìù Verificando formata√ß√£o com Black..."
$DOCKER_CMD poetry run black --check . || {
    echo "‚ùå Erro: C√≥digo n√£o est√° formatado com Black"
    echo "üí° Execute: poetry run black . (ou docker exec lacrei-2025-tl-web-1 poetry run black .)"
    exit 1
}

# Verifica ordena√ß√£o de imports com isort
echo ""
echo "üì¶ Verificando imports com isort..."
$DOCKER_CMD poetry run isort --check-only . || {
    echo "‚ùå Erro: Imports n√£o est√£o ordenados"
    echo "üí° Execute: poetry run isort . (ou docker exec lacrei-2025-tl-web-1 poetry run isort .)"
    exit 1
}

# Verifica estilo de c√≥digo com Flake8
echo ""
echo "üîé Verificando estilo com Flake8..."
$DOCKER_CMD poetry run flake8 . || {
    echo "‚ùå Erro: Problemas de estilo de c√≥digo detectados"
    exit 1
}

# Verifica tipos com MyPy (apenas app/)
echo ""
echo "üî¨ Verificando tipos com MyPy..."
$DOCKER_CMD poetry run mypy app/ || {
    echo "‚ùå Erro: Problemas de tipagem detectados"
    exit 1
}

# Verifica formata√ß√£o do Terraform
if command -v terraform &> /dev/null; then
    # Verifica se h√° arquivos terraform modificados
    TERRAFORM_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$' || true)
    
    if [ -n "$TERRAFORM_FILES" ]; then
        echo ""
        echo "üèóÔ∏è  Verificando formata√ß√£o do Terraform..."
        terraform fmt -check -recursive terraform/ || {
            echo "‚ùå Erro: Arquivos Terraform n√£o est√£o formatados"
            echo "üí° Execute: terraform fmt -recursive terraform/"
            exit 1
        }
    fi
else
    echo ""
    echo "‚ö†Ô∏è  Terraform n√£o encontrado, pulando verifica√ß√£o de formata√ß√£o Terraform"
fi

echo ""
echo "‚úÖ Todas as verifica√ß√µes passaram! Commit permitido."

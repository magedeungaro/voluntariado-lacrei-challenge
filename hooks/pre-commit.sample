#!/bin/bash
#
# Pre-commit hook para executar verificaÃ§Ãµes de qualidade de cÃ³digo
# Executa as mesmas verificaÃ§Ãµes do CI (Black, isort, Flake8, MyPy)
#
# Para instalar:
#   cp hooks/pre-commit.sample .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

echo "ğŸ” Executando verificaÃ§Ãµes de qualidade de cÃ³digo..."

# Verifica se estÃ¡ rodando dentro do Docker ou localmente
if command -v docker &> /dev/null && docker ps | grep -q lacrei-2025-tl-web-1; then
    DOCKER_CMD="docker exec lacrei-2025-tl-web-1"
    echo "âœ“ Usando container Docker"
else
    DOCKER_CMD=""
    echo "âœ“ Executando localmente"
fi

# Verifica formataÃ§Ã£o com Black
echo ""
echo "ğŸ“ Verificando formataÃ§Ã£o com Black..."
$DOCKER_CMD poetry run black --check . || {
    echo "âŒ Erro: CÃ³digo nÃ£o estÃ¡ formatado com Black"
    echo "ğŸ’¡ Execute: poetry run black . (ou docker exec lacrei-2025-tl-web-1 poetry run black .)"
    exit 1
}

# Verifica ordenaÃ§Ã£o de imports com isort
echo ""
echo "ğŸ“¦ Verificando imports com isort..."
$DOCKER_CMD poetry run isort --check-only . || {
    echo "âŒ Erro: Imports nÃ£o estÃ£o ordenados"
    echo "ğŸ’¡ Execute: poetry run isort . (ou docker exec lacrei-2025-tl-web-1 poetry run isort .)"
    exit 1
}

# Verifica estilo de cÃ³digo com Flake8
echo ""
echo "ğŸ” Verificando estilo com Flake8..."
$DOCKER_CMD poetry run flake8 . || {
    echo "âŒ Erro: Problemas de estilo de cÃ³digo detectados"
    exit 1
}

# Verifica tipos com MyPy (apenas app/)
echo ""
echo "ğŸ”¬ Verificando tipos com MyPy..."
$DOCKER_CMD poetry run mypy app/ || {
    echo "âŒ Erro: Problemas de tipagem detectados"
    exit 1
}

echo ""
echo "âœ… Todas as verificaÃ§Ãµes passaram! Commit permitido."
